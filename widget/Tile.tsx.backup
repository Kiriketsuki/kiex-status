import { Gtk, Gdk } from "ags/gtk4"
import {
  drawPolyTile,
  drawSubtileBoundaries,
  drawTriangle,
  getPolyTileWidth,
  TILE_HEIGHT,
} from "../lib/drawing"

interface TileProps {
  units: number
  offset?: number
  subtiles?: Record<number, string>
  baseColor?: string
  showGrid?: boolean
  children?: any
  className?: string
  css?: string
  [key: string]: any
}

export default function Tile({
  units,
  offset = 0,
  subtiles = {},
  baseColor = "rgba(50, 50, 50, 1)",
  showGrid = false,
  children,
  className,
  css,
  ...props
}: TileProps) {
  const width = getPolyTileWidth(units)
  const startUpright = offset % 2 === 0
  print(
    `[Tile] Rendering: units=${units}, width=${width}, offset=${offset}, startUpright=${startUpright}`
  )
  print(
    `[Tile] Props: baseColor=${baseColor}, showGrid=${showGrid}, hasChildren=${!!children}`
  )
  print(`[Tile] Subtiles:`, JSON.stringify(subtiles))

  return (
    <Gtk.Overlay
      class={className}
      css={`
        ${css || ""}
      `}
      {...props}
      setup={(self: Gtk.Overlay) => {
        // Set the DrawingArea as the main child
        const drawingArea = new Gtk.DrawingArea()
        drawingArea.set_content_width(width)
        drawingArea.set_content_height(TILE_HEIGHT)
        
        drawingArea.set_draw_func((_, cr, w, h) => {
          print(
            `[Tile] Drawing: w=${w}, h=${h}, expected=${width}x${TILE_HEIGHT}`
          )
            print(
              `[Tile] Drawing: w=${w}, h=${h}, expected=${width}x${TILE_HEIGHT}`
            )
            // 1. Base Shape
            const bg = new Gdk.RGBA()
            if (bg.parse(baseColor)) {
              cr.setSourceRGBA(bg.red, bg.green, bg.blue, bg.alpha)
            } else {
              cr.setSourceRGBA(0.2, 0.2, 0.2, 1)
            }

            drawPolyTile(cr, w, h, units, startUpright)
            cr.fill()
            print(`[Tile] Drew base tile`)

            // 2. Subtiles
            const subtileCount = Object.keys(subtiles).length
            print(`[Tile] Drawing ${subtileCount} subtiles`)
            for (const [indexStr, colorStr] of Object.entries(subtiles)) {
              const index = parseInt(indexStr)
              const color = new Gdk.RGBA()
              const parsed = color.parse(colorStr)
              print(
                `[Tile] Subtile ${index}: color=${colorStr}, parsed=${parsed}`
              )
              if (parsed) {
                cr.setSourceRGBA(
                  color.red,
                  color.green,
                  color.blue,
                  color.alpha
                )
                drawTriangle(cr, h, index, startUpright)
                cr.fill()
                print(`[Tile] Drew subtile ${index}`)
              }
            }

            // 3. Grid
            if (showGrid) {
              print(`[Tile] Drawing grid`)
              cr.setSourceRGBA(0, 0, 0, 0.5)
              cr.setLineWidth(1)
              drawSubtileBoundaries(cr, h, units, startUpright)
              cr.stroke()
              print(`[Tile] Drew grid`)
            }
          })
        
        self.set_child(drawingArea)
        print(`[Tile] Set DrawingArea as main child`)
        
        // Add overlay children if provided
        if (children) {
          const overlayBox = <box css="padding: 5px;">{children}</box> as Gtk.Widget
          self.add_overlay(overlayBox)
          print(`[Tile] Added overlay children`)
        }
      }}
    />
  )
}
