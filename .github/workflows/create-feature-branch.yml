name: Create Feature Branch
on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      issue_number:
        description: "Issue Number"
        required: true

jobs:
  create_branch:
    if: contains(github.event.issue.labels.*.name, 'feature') || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
    outputs:
      branch_name: ${{ steps.create.outputs.branch_name }}
      base_branch: ${{ steps.create.outputs.base_branch }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Create Branch
        id: create
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          if [ -z "$ISSUE_NUMBER" ]; then
            echo "Error: Issue Number is missing."
            exit 1
          fi

          # Fetch issue details
          ISSUE_JSON=$(gh issue view "$ISSUE_NUMBER" --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r .title)
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r .body)

          # Extract Parent Issue Number from body
          # Looking for "### Parent Task Issue Number" followed by the number
          PARENT_ID=$(echo "$ISSUE_BODY" | grep -A 2 "### Parent Task Issue Number" | tail -n 1 | tr -d ' \r\n')

          BASE_BRANCH="main"

          if [[ "$PARENT_ID" =~ ^[0-9]+$ ]]; then
            echo "Parent Issue ID found: $PARENT_ID"
            # Find branch starting with task/$PARENT_ID
            # We need to fetch all branches first
            git fetch --all
            PARENT_BRANCH=$(git branch -r | grep "origin/task/$PARENT_ID-" | head -n 1 | sed 's/origin\///' | xargs)
            
            if [ -n "$PARENT_BRANCH" ]; then
              echo "Found parent branch: $PARENT_BRANCH"
              BASE_BRANCH="$PARENT_BRANCH"
            else
              echo "Parent branch not found for issue $PARENT_ID. Defaulting to main."
            fi
          else
            echo "No valid parent issue ID found. Defaulting to main."
          fi

          # Sanitize title: lowercase, remove "feature" prefix, remove special chars, squeeze spaces, replace with dashes
          SAFE_TITLE=$(echo "$ISSUE_TITLE" | tr '[:upper:]' '[:lower:]' | sed -E 's/^\[?feature\]?[-: ]+ ?//' | sed -e 's/[^a-z0-9 ]//g' | tr -s ' ' | tr ' ' '-')
          BRANCH_NAME="feature/$ISSUE_NUMBER-$SAFE_TITLE"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

          # Check if branch exists
          if git ls-remote --exit-code --heads origin "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists. Skipping creation."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git checkout "$BASE_BRANCH"
          git checkout -b "$BRANCH_NAME"

          git commit --allow-empty -m "chore: initialize branch for issue #$ISSUE_NUMBER"
          git push origin "$BRANCH_NAME"

  create_pr:
    needs: create_branch
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Create PR
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ needs.create_branch.outputs.branch_name }}
          BASE_BRANCH: ${{ needs.create_branch.outputs.base_branch }}
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            ISSUE_NUMBER="${{ inputs.issue_number }}"
          else
            ISSUE_NUMBER="${{ github.event.issue.number }}"
          fi

          # Fetch issue details
          ISSUE_JSON=$(gh issue view "$ISSUE_NUMBER" --json title,body)
          ISSUE_TITLE=$(echo "$ISSUE_JSON" | jq -r .title)
          ISSUE_BODY=$(echo "$ISSUE_JSON" | jq -r .body)

          # Check if PR already exists
          if gh pr view "$BRANCH_NAME" --json url >/dev/null 2>&1; then
            echo "PR for branch $BRANCH_NAME already exists. Skipping."
            exit 0
          fi

          gh pr create --base "$BASE_BRANCH" --head "$BRANCH_NAME" --title "Adds #$ISSUE_NUMBER: $ISSUE_TITLE" --body "$ISSUE_BODY"$'\n\n'"This closes #$ISSUE_NUMBER" --label "addition" --draft

          gh issue comment "$ISSUE_NUMBER" --body "Created branch \`$BRANCH_NAME\` based on \`$BASE_BRANCH\` and opened draft PR."
