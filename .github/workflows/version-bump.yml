name: Version Bump

on:
  pull_request:
    types: [closed]
    branches:
      - main
      - "task/**"
      - "feature/**"
      - "bug/**"
  push:
    branches:
      - main
      - "task/**"
      - "feature/**"
      - "bug/**"

jobs:
  bump-version:
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Determine Bump Type
        id: bump_type
        run: |
          BUMP_TYPE="none"
          SOURCE_BRANCH=""
          TARGET_BRANCH="${{ github.ref_name }}"

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            SOURCE_BRANCH="${{ github.event.pull_request.head.ref }}"
          else
            # For push events, try to extract branch from commit message if it's a merge
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo "Commit message: $COMMIT_MSG"
            # Regex to find 'Merge pull request #... from .../branch-name' or 'Merge branch 'branch-name''
            if [[ "$COMMIT_MSG" =~ from\ .*/(task|feature|bug|hotfix)/ ]]; then
               SOURCE_BRANCH=$(echo "$COMMIT_MSG" | grep -oE '(task|feature|bug|hotfix)/[^ ]+')
            elif [[ "$COMMIT_MSG" =~ Merge\ branch\ \'(task|feature|bug|hotfix)/ ]]; then
               SOURCE_BRANCH=$(echo "$COMMIT_MSG" | grep -oE '(task|feature|bug|hotfix)/[^ ]+' | tr -d "'")
            fi
          fi

          echo "Source Branch: $SOURCE_BRANCH"
          echo "Target Branch: $TARGET_BRANCH"

          # Logic for bumping based on hierarchy
          # Hotfix -> Bug/Feature/Task: Bump Hotfix (letter suffix)
          # Bug -> Feature/Task: Bump Bug (4th digit)
          # Feature -> Task: Bump Feature (3rd digit)
          # Task -> Main: Bump Task (2nd digit)

          if [[ "$TARGET_BRANCH" == "main" ]]; then
            if [[ "$SOURCE_BRANCH" == task/* ]]; then
              BUMP_TYPE="task"
            elif [[ "$SOURCE_BRANCH" == feature/* ]]; then
              BUMP_TYPE="feature"
            elif [[ "$SOURCE_BRANCH" == bug/* ]]; then
              BUMP_TYPE="bug"
            elif [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
              BUMP_TYPE="hotfix"
            fi
          elif [[ "$TARGET_BRANCH" == task/* ]]; then
            if [[ "$SOURCE_BRANCH" == feature/* ]]; then
              BUMP_TYPE="feature"
            elif [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
              BUMP_TYPE="hotfix"
            fi
          elif [[ "$TARGET_BRANCH" == feature/* ]]; then
            if [[ "$SOURCE_BRANCH" == bug/* ]]; then
              BUMP_TYPE="bug"
            elif [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
              BUMP_TYPE="hotfix"
            fi
          elif [[ "$TARGET_BRANCH" == bug/* ]]; then
            if [[ "$SOURCE_BRANCH" == hotfix/* ]]; then
              BUMP_TYPE="hotfix"
            fi
          fi

          echo "Bump Type: $BUMP_TYPE"
          echo "BUMP_TYPE=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Bump Version
        if: steps.bump_type.outputs.BUMP_TYPE != 'none'
        run: |
          CURRENT_VERSION=$(cat VERSION)
          # Regex to parse Major.Task.Feature.Bug[Hotfix letter]
          # Examples: 0.1.0.0 (no hotfix), 0.1.0.0a (hotfix 'a'), 0.1.0.0b (hotfix 'b')
          if [[ "$CURRENT_VERSION" =~ ^([0-9]+)\.([0-9]+)\.([0-9]+)\.([0-9]+)([a-z]*)$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            TASK="${BASH_REMATCH[2]}"
            FEATURE="${BASH_REMATCH[3]}"
            BUG="${BASH_REMATCH[4]}"
            HOTFIX="${BASH_REMATCH[5]}"
          else
            echo "Error: Invalid version format in VERSION file: $CURRENT_VERSION"
            exit 1
          fi

          TYPE="${{ steps.bump_type.outputs.BUMP_TYPE }}"

          if [ "$TYPE" == "task" ]; then
            TASK=$((TASK + 1))
            FEATURE=0
            BUG=0
            HOTFIX=""
          elif [ "$TYPE" == "feature" ]; then
            FEATURE=$((FEATURE + 1))
            BUG=0
            HOTFIX=""
          elif [ "$TYPE" == "bug" ]; then
            BUG=$((BUG + 1))
            HOTFIX=""
          elif [ "$TYPE" == "hotfix" ]; then
            if [ -z "$HOTFIX" ]; then
              HOTFIX="a"
            else
              # Increment char: a->b, b->c
              # Convert char to ascii, add 1, convert back
              ASCII_VAL=$(printf "%d" "'$HOTFIX")
              NEXT_ASCII_VAL=$((ASCII_VAL + 1))
              HOTFIX=$(printf "\\$(printf '%03o' "$NEXT_ASCII_VAL")")
            fi
          fi

          NEW_VERSION="$MAJOR.$TASK.$FEATURE.$BUG$HOTFIX"
          echo "Bumping version from $CURRENT_VERSION to $NEW_VERSION"
          echo "$NEW_VERSION" > VERSION

          # Update package.json
          jq --arg v "$NEW_VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add VERSION package.json
          git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
          git push origin "${{ github.ref_name }}"
