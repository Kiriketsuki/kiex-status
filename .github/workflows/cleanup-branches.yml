name: Cleanup Merged Branches
on:
    pull_request:
        types: [closed]
    schedule:
        # Run weekly on Sundays at 00:00 UTC
        - cron: "0 0 * * 0"
    workflow_dispatch:

permissions:
    contents: write

jobs:
    cleanup:
        if: github.event.pull_request.merged == true || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Delete Merged PR Branch
              if: github.event_name == 'pull_request'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  HEAD_REF: ${{ github.event.pull_request.head.ref }}
              run: |
                  echo "Deleting merged branch: $HEAD_REF"

                  # Check if branch exists before attempting to delete
                  if git ls-remote --heads origin "$HEAD_REF" | grep -q "$HEAD_REF"; then
                    git push origin --delete "$HEAD_REF" || echo "Failed to delete branch (may already be deleted)"
                    echo "✅ Branch $HEAD_REF deleted"
                  else
                    echo "Branch $HEAD_REF does not exist or already deleted"
                  fi

            - name: Find and Delete Merged Branches (Scheduled)
              if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              run: |
                  echo "Finding merged branches to clean up..."

                  # Get default branch (usually main)
                  DEFAULT_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
                  echo "Default branch: $DEFAULT_BRANCH"

                  # Update remote refs
                  git fetch --prune

                  # Find merged branches (exclude main, release, task, feature, and protected branches)
                  # Task and Feature branches may be long-lived, so we don't auto-delete them
                  # Only auto-delete bug and hotfix branches once merged
                  MERGED_BRANCHES=$(git branch -r --merged origin/$DEFAULT_BRANCH | \
                    grep -v "origin/$DEFAULT_BRANCH" | \
                    grep -v "origin/release" | \
                    grep -v "origin/HEAD" | \
                    grep -v "origin/task/" | \
                    grep -v "origin/feature/" | \
                    sed 's|origin/||' | \
                    xargs)

                  if [ -z "$MERGED_BRANCHES" ]; then
                    echo "No merged branches found to clean up"
                    exit 0
                  fi

                  echo "Found merged branches: $MERGED_BRANCHES"
                  echo "Note: Task and Feature branches are excluded from automatic cleanup"

                  # Delete each merged branch
                  for branch in $MERGED_BRANCHES; do
                    echo "Deleting merged branch: $branch"
                    git push origin --delete "$branch" || echo "Failed to delete $branch (may be protected)"
                  done

                  echo "✅ Cleanup complete"
